---
/** Rideau noir qui:
 *  - s’allume (opacity 1) avant de quitter la page
 *  - s’éteint (opacity 0) à l’arrivée
 */
---
<div
  id="light-curtain"
  class="fixed inset-0 z-50 bg-black opacity-0 pointer-events-none transition-opacity duration-[250ms] ease-[cubic-bezier(0.4,0,0.2,1)]"
></div>

<script is:inline>
  (() => {
    if (typeof window === 'undefined' || typeof document === 'undefined') return;

    const STORAGE_KEY = 'light-curtain-transition';
    const FADE_DURATION = 250; // durée du fondu
    const HOLD_BEFORE_NAV = 250; // noir plein avant navigation

    const curtain = document.getElementById('light-curtain');
    if (!curtain) return;

    const toggleCurtain = (visible, { instant = false } = {}) => {
      if (instant) {
        const prev = curtain.style.transition;
        curtain.style.transition = 'none';
        curtain.offsetHeight;
        applyVisibility(visible);
        requestAnimationFrame(() => {
          curtain.style.transition = prev;
        });
      } else {
        applyVisibility(visible);
      }
    };

    const applyVisibility = (visible) => {
      if (visible) {
        curtain.classList.add('opacity-100', 'pointer-events-auto');
        curtain.classList.remove('opacity-0', 'pointer-events-none');
      } else {
        curtain.classList.add('opacity-0', 'pointer-events-none');
        curtain.classList.remove('opacity-100', 'pointer-events-auto');
      }
    };

    const getFlag = () => {
      try {
        return window.sessionStorage.getItem(STORAGE_KEY) === '1';
      } catch {
        return false;
      }
    };

    const setFlag = () => {
      try {
        window.sessionStorage.setItem(STORAGE_KEY, '1');
      } catch {}
    };

    const clearFlag = () => {
      try {
        window.sessionStorage.removeItem(STORAGE_KEY);
      } catch {}
    };

    const wasTransitioning = getFlag();

    if (wasTransitioning) {
      toggleCurtain(true, { instant: true });
    } else {
      toggleCurtain(false, { instant: true });
    }

    const revealCurrentPage = () => {
      if (wasTransitioning) {
        setTimeout(() => {
          toggleCurtain(false);
          clearFlag();
        }, 0);
      } else {
        requestAnimationFrame(() => toggleCurtain(false));
      }
    };

    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      revealCurrentPage();
    } else {
      window.addEventListener('DOMContentLoaded', revealCurrentPage, { once: true });
    }

    window.startTransition = (url) => {
      if (!url) return;
      setFlag();
      toggleCurtain(true);
      setTimeout(() => {
        window.location.href = url;
      }, FADE_DURATION + HOLD_BEFORE_NAV);
    };

    document.addEventListener('click', (event) => {
      const target = event.target;
      if (!(target instanceof Element)) return;
      const link = target.closest('a[data-transition]');
      if (link && link.href) {
        event.preventDefault();
        window.startTransition(link.href);
      }
    });
  })();
</script>
