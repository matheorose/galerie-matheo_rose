---
import type { Project, FrameName } from "../data/projects";
import frameImage from "../assets/cadre.png";
import frameImage2 from "../assets/cadre2.png";
import frameImage3 from "../assets/cadre3.png";

type Props = {
  project: Project;
  projects?: Project[];
  initialIndex?: number;
};

const { project, projects: projectList = [project], initialIndex = 0 } = Astro.props as Props;
const safeProjects = projectList.length ? projectList : [project];
const normalizedIndex = Math.min(Math.max(initialIndex, 0), safeProjects.length - 1);
const currentProject = safeProjects[normalizedIndex] ?? project;
const dialogId = "project-dialog";
const projectsJson = JSON.stringify(safeProjects).replace(/</g, "\\u003c");
const frameSources = {
  cadre: frameImage.src,
  cadre2: frameImage2.src,
  cadre3: frameImage3.src,
} as const;

const resolveFrameSrc = (cadre?: FrameName) =>
  (cadre ? frameSources[cadre] : undefined) ?? frameSources.cadre;

const frameSourcesJson = JSON.stringify(frameSources).replace(/</g, "\\u003c");
const initialFrameSrc = resolveFrameSrc(currentProject.cadre);
---

<div
  class="mx-auto max-w-[1200px] text-center"
  data-carousel-root
  data-initial-index={normalizedIndex}
  data-projects={projectsJson}
  data-dialog-id={dialogId}
  data-frame-sources={frameSourcesJson}
>
  <header
    class="absolute left-1/2 top-[6vh] -translate-x-1/2 text-center tracking-[0.06em]"
  >
    <div class="flex flex-wrap items-center justify-center gap-12">
      <a
        class="inline-flex items-center gap-2 rounded-full border border-black/10 px-4 py-2 text-xs md:text-sm text-[#111] opacity-80 backdrop-blur-md transition hover:opacity-100"
        href="/"
        data-transition
        aria-label="Retour à l’accueil"
      >
        <svg class="w-4" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" version="1.1" width="100%" height="100%" viewBox="0 0 14 14" id="svg2">
          <metadata id="metadata8">
            <rdf:RDF>
              <cc:Work
                rdf:about="">
                <dc:format>image/svg+xml</dc:format>
                <dc:type
                  rdf:resource="http://purl.org/dc/dcmitype/StillImage" />
                <dc:title></dc:title>
              </cc:Work>
            </rdf:RDF>
          </metadata>
          <defs id="defs6" />
          <rect x="0" y="0" id="canvas" style="fill:none;stroke:none;visibility:hidden" />
          <path d="M 7,1 1,3 1,4 13,4 13,3 z m -6,4 0,1 1,0 0,5 -1,0 -1,2 14,0 -1,-2 -1,0 0,-5 1,0 0,-1 z M 5,6 C 5.497372,6 6,6.5325904 6,7 L 6,11 4,11 4,7 C 4,6.4726661 4.502628,6 5,6 z m 4,0 c 0.503364,0 1,0.4726661 1,1 l 0,4 -2,0 0,-4 C 8,6.4726661 8.496636,6 9,6 z" id="museum" style="fill:#000000;fill-opacity:1;stroke:none" />
        </svg> 
        Accueil
      </a>
      <div
        class="font-['Space_Grotesk',_Inter,_sans-serif] text-[clamp(22px,3.8vw,44px)] font-semibold"
        data-carousel-title
      >
        {currentProject.title} — {currentProject.year}
      </div>
      <a
        class="inline-flex items-center gap-2 rounded-full border border-black/10 px-4 py-2 text-xs md:text-sm text-[#111] opacity-80 backdrop-blur-md transition hover:opacity-100"
        href="/"
        data-transition
        aria-label="Retour à l’accueil"
      >
        Crédits
        <svg class="w-4" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M15 12C15 13.6569 13.6569 15 12 15C10.3432 15 9.00004 13.6569 9.00004 12C9.00004 10.3432 10.3432 9.00004 12 9.00004C13.6569 9.00004 15 10.3432 15 12Z" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M7.64338 5.18899L7.56701 6.10541C7.52707 6.58478 7.50709 6.82447 7.40373 7.01167C7.31261 7.1767 7.1767 7.31261 7.01167 7.40373C6.82447 7.50709 6.58477 7.52707 6.10541 7.56701L5.18898 7.64338C4.16259 7.72892 3.6494 7.77168 3.39642 8.00615C3.17627 8.21018 3.05941 8.50232 3.07812 8.8019C3.09961 9.14615 3.44174 9.53105 4.126 10.3008L4.69153 10.9371C5.02586 11.3132 5.19302 11.5012 5.2565 11.7135C5.31243 11.9004 5.31243 12.0997 5.2565 12.2866C5.19302 12.4988 5.02586 12.6869 4.69153 13.063L4.126 13.6992C3.44174 14.469 3.09961 14.8539 3.07812 15.1982C3.05941 15.4978 3.17627 15.7899 3.39642 15.9939C3.6494 16.2284 4.16259 16.2712 5.18899 16.3567L6.10541 16.4331C6.58478 16.473 6.82446 16.493 7.01167 16.5964C7.1767 16.6875 7.31261 16.8234 7.40373 16.9884C7.50709 17.1756 7.52707 17.4153 7.56701 17.8947L7.64338 18.8111C7.72892 19.8375 7.77168 20.3507 8.00615 20.6037C8.21018 20.8238 8.50232 20.9407 8.8019 20.922C9.14615 20.9005 9.53105 20.5583 10.3008 19.8741L10.9371 19.3085C11.3132 18.9742 11.5012 18.8071 11.7135 18.7436C11.9004 18.6876 12.0997 18.6876 12.2866 18.7436C12.4988 18.8071 12.6869 18.9742 13.063 19.3085L13.6992 19.8741C14.469 20.5583 14.8539 20.9005 15.1982 20.922C15.4978 20.9407 15.7899 20.8238 15.9939 20.6037C16.2284 20.3507 16.2712 19.8375 16.3567 18.8111L16.4331 17.8947C16.473 17.4153 16.493 17.1756 16.5964 16.9884C16.6875 16.8234 16.8234 16.6875 16.9884 16.5964C17.1756 16.493 17.4153 16.473 17.8947 16.4331L18.8111 16.3567C19.8375 16.2712 20.3507 16.2284 20.6037 15.9939C20.8238 15.7899 20.9407 15.4978 20.922 15.1982C20.9005 14.8539 20.5583 14.469 19.8741 13.6992L19.3085 13.063C18.9742 12.6869 18.8071 12.4988 18.7436 12.2866C18.6876 12.0997 18.6876 11.9004 18.7436 11.7135C18.8071 11.5012 18.9742 11.3132 19.3085 10.9371L19.8741 10.3008C20.5583 9.53105 20.9005 9.14615 20.922 8.8019C20.9407 8.50232 20.8238 8.21018 20.6037 8.00615C20.3507 7.77168 19.8375 7.72892 18.8111 7.64338L17.8947 7.56701C17.4153 7.52707 17.1756 7.50709 16.9884 7.40373C16.8234 7.31261 16.6875 7.1767 16.5964 7.01167C16.493 6.82446 16.473 6.58478 16.4331 6.10541L16.3567 5.18898C16.2712 4.16259 16.2284 3.6494 15.9939 3.39642C15.7899 3.17627 15.4978 3.05941 15.1982 3.07812C14.8539 3.09961 14.469 3.44174 13.6992 4.126L13.063 4.69153C12.6869 5.02586 12.4988 5.19302 12.2866 5.2565C12.0997 5.31243 11.9004 5.31243 11.7135 5.2565C11.5012 5.19302 11.3132 5.02586 10.9371 4.69153L10.3008 4.126C9.53105 3.44174 9.14615 3.09961 8.8019 3.07812C8.50232 3.05941 8.21018 3.17627 8.00615 3.39642C7.77168 3.6494 7.72892 4.16259 7.64338 5.18899Z" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </a>
    </div>
  </header>

  <div class="mt-24 flex flex-col items-center gap-8">
    <div class="relative mx-auto flex w-[min(640px,82vw)] justify-center">
      <div
        class="relative w-full aspect-[32/21] overflow-hidden rounded-[16px] border border-black/10 bg-[#fafafa]"
        data-carousel-media
      >
        <img
          class="absolute inset-0 h-full w-full object-cover"
          src={currentProject.cover}
          alt={currentProject.title}
          loading="lazy"
          data-carousel-cover
        />
      </div>
      <img
        src={initialFrameSrc}
        alt="Cadre décoratif"
        loading="lazy"
        class="pointer-events-none absolute left-1/2 top-1/2 h-[250%] w-[115%] max-h-none max-w-none -translate-x-1/2 -translate-y-1/2 object-contain"
        data-carousel-frame
      />
    </div>

    <div
      class="mt-[2.2rem] text-center text-[clamp(12px,1.1vw,14px)] text-[#5A5A5A]"
      data-carousel-meta
    >
      <div class="text-[0.85rem] uppercase tracking-[0.25em]" data-carousel-role>
        Rôle : {currentProject.role}
      </div>
      <p class="mt-3 text-[clamp(14px,1.5vw,18px)] text-[#111]" data-carousel-tagline>
        {currentProject.tagline}
      </p>
      <button
        class="mt-[18px] inline-flex cursor-pointer items-center gap-2 rounded-full border border-black/10 px-6 py-3 text-[clamp(14px,1.5vw,18px)] text-[#111] opacity-100 backdrop-blur-md transition hover:opacity-60"
        type="button"
        data-dialog-trigger={dialogId}
      >
        Voir plus
        <svg class="size-3 md:size-3" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M12.2929 4.29289C12.6834 3.90237 13.3166 3.90237 13.7071 4.29289L20.7071 11.2929C21.0976 11.6834 21.0976 12.3166 20.7071 12.7071L13.7071 19.7071C13.3166 20.0976 12.6834 20.0976 12.2929 19.7071C11.9024 19.3166 11.9024 18.6834 12.2929 18.2929L17.5858 13H4C3.44772 13 3 12.5523 3 12C3 11.4477 3.44772 11 4 11H17.5858L12.2929 5.70711C11.9024 5.31658 11.9024 4.68342 12.2929 4.29289Z" fill="#000000" />
        </svg>
      </button>
    </div>
  </div>
</div>

<dialog
  id={dialogId}
  class="w-full max-w-[min(760px,90vw)] rounded-2xl border-0 p-7 shadow-[0_10px_50px_rgba(0,0,0,0.12)]"
>
  <div class="mb-[10px] font-semibold" data-dialog-title>
    {currentProject.title} — {currentProject.year}
  </div>
  <div class="text-sm text-[#5A5A5A]" data-dialog-role>Rôle : {currentProject.role}</div>
  <p class="mt-3 text-base text-[#111]" data-dialog-description>{currentProject.tagline}</p>
  <p
    class="mt-2 text-base"
    data-dialog-link-wrapper
    hidden={!currentProject.href}
  >
    <a
      class="underline"
      href={currentProject.href ?? "#"}
      target="_blank"
      rel="noreferrer"
      data-dialog-link
    >
      Voir le site
    </a>
  </p>
  <button
    class="mt-4 inline-flex items-center justify-center rounded-full border border-black/10 px-4 py-2 text-sm"
    type="button"
    data-dialog-close
  >
    Fermer
  </button>
</dialog>

<script is:inline>
  (() => {
    if (typeof window === 'undefined' || typeof document === 'undefined') return;

    const root = document.querySelector('[data-carousel-root]');
    if (!root) return;

    const projectsAttr = root.getAttribute('data-projects');
    if (!projectsAttr) return;

    let projects;
    try {
      projects = JSON.parse(projectsAttr);
    } catch {
      return;
    }

    if (!Array.isArray(projects) || projects.length === 0) return;

    const frameSourcesAttr = root.getAttribute('data-frame-sources');
    let frameSources = {};
    if (frameSourcesAttr) {
      try {
        const parsedSources = JSON.parse(frameSourcesAttr);
        if (parsedSources && typeof parsedSources === 'object') {
          frameSources = parsedSources;
        }
      } catch {
        /* noop */
      }
    }

    const total = projects.length;
    const clampIndex = (value) => {
      const mod = value % total;
      return mod >= 0 ? mod : total + mod;
    };

    let index = Number(root.getAttribute('data-initial-index')) || 0;
    index = clampIndex(index);

    const mediaEl = root.querySelector('[data-carousel-media]');
    const metaEl = root.querySelector('[data-carousel-meta]');
    const frameEl = root.querySelector('[data-carousel-frame]');
    const coverEl = root.querySelector('[data-carousel-cover]');
    const titleEl = root.querySelector('[data-carousel-title]');
    const roleEl = root.querySelector('[data-carousel-role]');
    const taglineEl = root.querySelector('[data-carousel-tagline]');
    const viewMoreBtn = root.querySelector('[data-dialog-trigger]');
    const dialogId = root.getAttribute('data-dialog-id');
    const dialogEl = dialogId ? document.getElementById(dialogId) : null;
    const dialogTitle = dialogEl?.querySelector('[data-dialog-title]');
    const dialogRole = dialogEl?.querySelector('[data-dialog-role]');
    const dialogDescription = dialogEl?.querySelector('[data-dialog-description]');
    const dialogLinkWrapper = dialogEl?.querySelector('[data-dialog-link-wrapper]');
    const dialogLink = dialogEl?.querySelector('[data-dialog-link]');

    if (!frameSources.cadre && frameEl instanceof HTMLImageElement) {
      frameSources.cadre = frameEl.getAttribute('src') || frameEl.src || '';
    }

    const animatedElements = [mediaEl, metaEl, frameEl].filter((el) => el instanceof HTMLElement);
    const TRANSITION = 450;
    let isAnimating = false;

    const syncUrl = (project) => {
      if (!project?.slug || typeof window === 'undefined' || !window.history?.replaceState) return;
      const ensureSlash = (path) => (path.endsWith('/') ? path : `${path}/`);
      const currentPath = ensureSlash(window.location.pathname);
      const desiredPath = ensureSlash(`/${project.slug}`);
      if (currentPath !== desiredPath) {
        try {
          window.history.replaceState({}, '', desiredPath);
        } catch {
          /* noop */
        }
      }
    };

    const resolveFrameSrc = (cadre) => {
      if (cadre && typeof cadre === 'string' && frameSources[cadre]) {
        return frameSources[cadre];
      }
      return frameSources.cadre;
    };

    const renderProject = () => {
      const project = projects[index];
      if (!project) return;
      if (coverEl) {
        coverEl.src = project.cover;
        coverEl.alt = project.title;
      }
      const nextFrameSrc = resolveFrameSrc(project.cadre);
      if (frameEl instanceof HTMLImageElement && nextFrameSrc) {
        frameEl.src = nextFrameSrc;
      }
      if (titleEl) titleEl.textContent = `${project.title} — ${project.year}`;
      if (roleEl) roleEl.textContent = `Rôle : ${project.role}`;
      if (taglineEl) taglineEl.textContent = project.tagline ?? '';
      if (dialogTitle) dialogTitle.textContent = `${project.title} — ${project.year}`;
      if (dialogRole) dialogRole.textContent = `Rôle : ${project.role}`;
      if (dialogDescription) dialogDescription.textContent = project.tagline ?? '';
      if (dialogLinkWrapper && dialogLink) {
        if (project.href) {
          dialogLinkWrapper.hidden = false;
          dialogLink.href = project.href;
        } else {
          dialogLinkWrapper.hidden = true;
        }
      }
      syncUrl(project);
    };

    const animateTo = (direction) => {
      if (total <= 1) return;
      if (isAnimating) return;
      isAnimating = true;

      const outClass = direction === 'next' ? 'carousel-anim-out-left' : 'carousel-anim-out-right';
      const inClass = direction === 'next' ? 'carousel-anim-in-right' : 'carousel-anim-in-left';

      animatedElements.forEach((el) => {
        el.classList.remove('carousel-anim-in-left', 'carousel-anim-in-right', 'carousel-anim-out-left', 'carousel-anim-out-right');
        void el.offsetWidth;
        el.classList.add(outClass);
      });

      setTimeout(() => {
        animatedElements.forEach((el) => el.classList.remove(outClass));
        index = clampIndex(direction === 'next' ? index + 1 : index - 1);
        renderProject();
        animatedElements.forEach((el) => {
          void el.offsetWidth;
          el.classList.add(inClass);
        });
        setTimeout(() => {
          animatedElements.forEach((el) => el.classList.remove(inClass));
          isAnimating = false;
        }, TRANSITION);
      }, TRANSITION);
    };

    const setupNavButtons = () => {
      const navButtons = document.querySelectorAll('[data-carousel-nav]');
      navButtons.forEach((btn) => {
        if (total <= 1) {
          btn.setAttribute('disabled', 'true');
          btn.classList.add('opacity-30', 'cursor-not-allowed');
        }
        btn.addEventListener('click', (event) => {
          event.preventDefault();
          if (total <= 1) return;
          const dir = btn.getAttribute('data-carousel-nav') === 'next' ? 'next' : 'prev';
          animateTo(dir);
        });
      });
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupNavButtons, { once: true });
    } else {
      setupNavButtons();
    }

    if (viewMoreBtn && dialogEl) {
      viewMoreBtn.addEventListener('click', (event) => {
        event.preventDefault();
        dialogEl.showModal();
      });
      dialogEl.querySelectorAll('[data-dialog-close]').forEach((btn) => {
        btn.addEventListener('click', () => dialogEl.close());
      });
    }

    renderProject();
  })();
</script>

<style>
  #project-dialog {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    margin: 0;
  }

  [data-carousel-media],
  [data-carousel-meta] {
    will-change: transform, opacity;
  }

  .carousel-anim-out-left {
    animation: carouselSlideOutLeft 0.45s cubic-bezier(0.4, 0, 0.2, 1) forwards;
  }

  .carousel-anim-out-right {
    animation: carouselSlideOutRight 0.45s cubic-bezier(0.4, 0, 0.2, 1) forwards;
  }

  .carousel-anim-in-left {
    animation: carouselSlideInLeft 0.45s cubic-bezier(0.4, 0, 0.2, 1) forwards;
  }

  .carousel-anim-in-right {
    animation: carouselSlideInRight 0.45s cubic-bezier(0.4, 0, 0.2, 1) forwards;
  }

  @keyframes carouselSlideOutLeft {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(-25%); opacity: 0; }
  }

  @keyframes carouselSlideOutRight {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(25%); opacity: 0; }
  }

  @keyframes carouselSlideInLeft {
    from { transform: translateX(-25%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  @keyframes carouselSlideInRight {
    from { transform: translateX(25%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
</style>
